<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cbSQL">
	
	<select id="getDongList" resultType="cbVO" parameterType="cbVO">
		SELECT
		    DISTINCT(bjdong_nm)    
		FROM
		    sales
		WHERE
		    sgg_nm=#{sgg_nm}
		ORDER BY
	           bjdong_nm
	</select>
	
	<select id="getGradeList" resultType="cbVO">
		SELECT
		    *
		FROM
		    amtgrade
	</select>
	
	<select id="getAptList" resultType="cbVO" parameterType="cbVO">

SELECT
    rno, grade , SGG_NM, bjdong_nm, jibeon, bldg_nm, deal_cnt, avg_amt, range_area
FROM

(
	SELECT
	    Rownum rno, grade , SGG_NM, bjdong_nm, jibeon, bldg_nm, deal_cnt, avg_amt, range_area
	FROM
	    (
	    SELECT 
	        SGG_NM, bjdong_nm, jibeon, bldg_nm, deal_cnt, avg_amt, range_area
	    FROM
	        (
	            SELECT 
	                sub.sgg_nm sgg_nm, sub.bjdong_nm bjdong_nm, sub.jibeon jibeon, sub.bldg_nm bldg_nm, deal_cnt, avg_amt, range_area
	            FROM 
	                (
	                SELECT 
	                    sgg_nm, bjdong_nm, jibeon, bldg_nm, ROW_NUMBER() OVER (PARTITION BY dongjibeon ORDER BY aptname) rn
	                FROM 
	                    (
	                        SELECT
	                            bjdong_nm, bonbeon || DECODE(bubeon, '0', null, '-' || bubeon) jibeon, SGG_NM, bldg_nm, bjdong_nm || ' ' || bonbeon || DECODE(bubeon, '0', null, '-' || bubeon) dongjibeon,
	                            sgg_nm || ' ' || bldg_nm  aptname
	                        FROM
	                            sales
	                        GROUP BY
	                            bjdong_nm, bonbeon, bubeon, sgg_nm, bldg_nm
	                        ORDER BY
	                            bjdong_nm, bonbeon, bubeon
	                    )
	                ) sub,(
	                        SELECT 
	                            bjdong_nm, bonbeon||DECODE(bubeon, '0', null, '-'||bubeon) jibeon,   DECODE(round(min(bldg_area) / 3.3), round(max(bldg_area) / 3.3), to_char(round(min(bldg_area) / 3.3)), round(min(bldg_area) / 3.3) || ' ~ ' || round(max(bldg_area) / 3.3)) range_area,round(avg(obj_amt)) avg_amt, count(*) deal_cnt 
	                        FROM
	                                  (
	                                SELECT
	                                    acc_year, sgg_nm, bjdong_nm, bonbeon, bubeon, bldg_nm, deal_ymd, obj_amt, bldg_area, build_year
	                                FROM
	                                    sales
	                                WHERE
	                                    sgg_nm = #{sgg_nm}
	                                    AND bjdong_nm = #{bjdong_nm}
	                                    
	                                )
	                        GROUP BY 
	                            bjdong_nm, bonbeon, bubeon
	                            ) deal
	            WHERE 
	                rn = 1
	                AND sub.bjdong_nm = deal.bjdong_nm
	                AND sub.jibeon = deal.jibeon
	            ORDER BY
	                deal_cnt desc
	        )
	    ),amtgrade
    WHERE
        avg_amt BETWEEN low_amt AND high_amt 
        AND grade = #{grade}
        )
WHERE
	rno BETWEEN #{startRno} AND #{endRno}
	</select>
	
	<select id="selTotal" resultType="int" parameterType="cbVO">
SELECT
    count(*)
FROM
    (
	SELECT
	    Rownum rno, grade , SGG_NM, bjdong_nm, jibeon, bldg_nm, deal_cnt, avg_amt, range_area
	FROM
	    (
	    SELECT 
	        SGG_NM, bjdong_nm, jibeon, bldg_nm, deal_cnt, avg_amt, range_area
	    FROM
	        (
	            SELECT 
	                sub.sgg_nm sgg_nm, sub.bjdong_nm bjdong_nm, sub.jibeon jibeon, sub.bldg_nm bldg_nm, deal_cnt, avg_amt, range_area
	            FROM 
	                (
	                SELECT 
	                    sgg_nm, bjdong_nm, jibeon, bldg_nm, ROW_NUMBER() OVER (PARTITION BY dongjibeon ORDER BY aptname) rn
	                FROM 
	                    (
	                        SELECT
	                            bjdong_nm, bonbeon || DECODE(bubeon, '0', null, '-' || bubeon) jibeon, SGG_NM, bldg_nm, bjdong_nm || ' ' || bonbeon || DECODE(bubeon, '0', null, '-' || bubeon) dongjibeon,
	                            sgg_nm || ' ' || bldg_nm  aptname
	                        FROM
	                            sales
	                        GROUP BY
	                            bjdong_nm, bonbeon, bubeon, sgg_nm, bldg_nm
	                        ORDER BY
	                            bjdong_nm, bonbeon, bubeon
	                    )
	                ) sub,(
	                        SELECT 
	                            bjdong_nm, bonbeon||DECODE(bubeon, '0', null, '-'||bubeon) jibeon,   DECODE(round(min(bldg_area) / 3.3), round(max(bldg_area) / 3.3), to_char(round(min(bldg_area) / 3.3)), round(min(bldg_area) / 3.3) || ' ~ ' || round(max(bldg_area) / 3.3)) range_area,round(avg(obj_amt)) avg_amt, count(*) deal_cnt 
	                        FROM
	                                  (
	                                SELECT
	                                    acc_year, sgg_nm, bjdong_nm, bonbeon, bubeon, bldg_nm, deal_ymd, obj_amt, bldg_area, build_year
	                                FROM
	                                    sales
	                                WHERE
	                                    sgg_nm = #{sgg_nm}
	                                    AND bjdong_nm = #{bjdong_nm}
	                                    
	                                )
	                        GROUP BY 
	                            bjdong_nm, bonbeon, bubeon
	                            ) deal
	            WHERE 
	                rn = 1
	                AND sub.bjdong_nm = deal.bjdong_nm
	                AND sub.jibeon = deal.jibeon
	            ORDER BY
	                deal_cnt desc
	        )
	    ),amtgrade
    WHERE
        avg_amt BETWEEN low_amt AND high_amt 
        AND grade = #{grade}
        )
	</select>
</mapper>