<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cbSQL">
	
	<select id="getDongList" resultType="cbVO" parameterType="cbVO">
		SELECT
		    DISTINCT(bjdong_nm)    
		FROM
		    sales
		WHERE
		    sgg_nm=#{sgg_nm}
	</select>
	
	<select id="getGradeList" resultType="cbVO">
		SELECT
		    *
		FROM
		    amtgrade
	</select>
	
	<select id="getAptList" resultType="cbVO" parameterType="cbVO">
	
		select
		    rno, sgg_nm, bjdong_nm, jibeon, bldg_nm, deal_cnt,avg_amt, avg_area 
		from
		    (
		    SELECT 
		       rownum rno, SGG_NM, bjdong_nm, jibeon, bldg_nm, deal_cnt, avg_amt, avg_area
		    FROM
		        (
		            SELECT 
		                sub.SGG_NM SGG_NM, sub.bjdong_nm BJDONG_NM, sub.jibeon JIBEON, sub.bldg_nm BLDG_NM, deal_cnt DEAL_CNT, avg_amt, avg_area
		            FROM 
		                (
		                SELECT 
		                    SGG_NM, bjdong_nm, jibeon, BLDG_NM, ROW_NUMBER() OVER (PARTITION BY 동지번 ORDER BY 아파트이름) AS rn
		                FROM 
		                    (
		                        SELECT
		                            bjdong_nm, bonbeon || DECODE(bubeon, '0', null, '-' || bubeon) jibeon, SGG_NM, bldg_nm, bjdong_nm || ' ' || bonbeon || DECODE(bubeon, '0', null, '-' || bubeon) AS 동지번,
		                            SGG_NM || ' ' || BLDG_NM AS 아파트이름
		                        FROM
		                            SALES
		                        GROUP BY
		                            bjdong_nm, bonbeon, bubeon, SGG_NM, BLDG_NM
		                        ORDER BY
		                            bjdong_nm, bonbeon, bubeon
		                    )
		                ) sub,(
		                        SELECT 
		                            bjdong_nm, bonbeon||DECODE(bubeon, '0', null, '-'||bubeon) jibeon, round(avg(area) / 3.3) avg_area,round(avg(obj_amt)) avg_amt, count(*) deal_cnt 
		                        FROM
		                                  (
		                                SELECT
		                                    ACC_YEAR, SGG_CD, SGG_NM, BJDONG_CD, BJDONG_NM, LAND_GBN, LAND_GBN_NM, BONBEON, BUBEON, BLDG_NM, DEAL_YMD, OBJ_AMT, round(BLDG_AREA) area, TOT_AREA, FLOOR, RIGHT_GBN, CNTL_YMD, BUILD_YEAR, HOUSE_TYPE, REQ_GBN, RDEALER_LAWDNM
		                                FROM
		                                    sales, amtgrade
		                                WHERE
		                                    grade = #{grade}
		                                    AND obj_amt between low_amt and high_amt
		                                    AND bjdong_nm = #{bjdong_nm}
		                                )
		                        GROUP BY 
		                            bjdong_nm, bonbeon, bubeon
		                        ORDER BY 
		                            bjdong_nm, bonbeon, bubeon 
		                            ) deal
		            WHERE 
		                rn = 1
		                AND sub.bjdong_nm = deal.bjdong_nm
		                AND sub.jibeon = deal.jibeon
		            order by
		                deal_cnt desc
		            
		        ) li
		    )
		    WHERE
		   		rno BETWEEN #{startRno} AND #{endRno}
	</select>
	
		<select id="selTotal" resultType="int" parameterType="cbVO">
		select
		    count(*)
		from
		    (
		    SELECT 
		       rownum rno, SGG_NM, bjdong_nm, jibeon, bldg_nm, deal_cnt, avg_amt, avg_area
		    FROM
		        (
		            SELECT 
		                sub.SGG_NM SGG_NM, sub.bjdong_nm BJDONG_NM, sub.jibeon JIBEON, sub.bldg_nm BLDG_NM, deal_cnt DEAL_CNT, avg_amt, avg_area
		            FROM 
		                (
		                SELECT 
		                    SGG_NM, bjdong_nm, jibeon, BLDG_NM, ROW_NUMBER() OVER (PARTITION BY 동지번 ORDER BY 아파트이름) AS rn
		                FROM 
		                    (
		                        SELECT
		                            bjdong_nm, bonbeon || DECODE(bubeon, '0', null, '-' || bubeon) jibeon, SGG_NM, bldg_nm, bjdong_nm || ' ' || bonbeon || DECODE(bubeon, '0', null, '-' || bubeon) AS 동지번,
		                            SGG_NM || ' ' || BLDG_NM AS 아파트이름
		                        FROM
		                            SALES
		                        GROUP BY
		                            bjdong_nm, bonbeon, bubeon, SGG_NM, BLDG_NM
		                        ORDER BY
		                            bjdong_nm, bonbeon, bubeon
		                    )
		                ) sub,(
		                        SELECT 
		                            bjdong_nm, bonbeon||DECODE(bubeon, '0', null, '-'||bubeon) jibeon, round(avg(area) / 3.3) avg_area,round(avg(obj_amt)) avg_amt, count(*) deal_cnt 
		                        FROM
		                                  (
		                                SELECT
		                                    ACC_YEAR, SGG_CD, SGG_NM, BJDONG_CD, BJDONG_NM, LAND_GBN, LAND_GBN_NM, BONBEON, BUBEON, BLDG_NM, DEAL_YMD, OBJ_AMT, round(BLDG_AREA) area, TOT_AREA, FLOOR, RIGHT_GBN, CNTL_YMD, BUILD_YEAR, HOUSE_TYPE, REQ_GBN, RDEALER_LAWDNM
		                                FROM
		                                    sales, amtgrade
		                                WHERE
		                                    grade = #{grade}
		                                    AND obj_amt between low_amt and high_amt
		                                    AND bjdong_nm = #{bjdong_nm}
		                                )
		                        GROUP BY 
		                            bjdong_nm, bonbeon, bubeon
		                        ORDER BY 
		                            bjdong_nm, bonbeon, bubeon 
		                            ) deal
		            WHERE 
		                rn = 1
		                AND sub.bjdong_nm = deal.bjdong_nm
		                AND sub.jibeon = deal.jibeon
		            order by
		                deal_cnt desc
		            
		        ) li
		    )
	</select>
	
	
</mapper>